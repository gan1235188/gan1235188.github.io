<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="apple-touch-icon" sizes="114x114" href="./assets/icon.png" />
  <link rel="apple-touch-startup-image" sizes="640x960" href="./assets/icon.png" />
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0;" name="viewport" />
  <title>Calm</title>
</head>

<body>
  <p id="status">已停止</p>
  <button id="start">开始</button>
  <button id="stop">停止</button>
  <audio id="audioEl"></audio>
  <script>
    document.getElementById("start").addEventListener('click', start);
    document.getElementById("stop").addEventListener('click', stop);

    const timeSpace = 1000;
    let streamSource;
    let timer;
    let mediaRecorder;
    let stream;
    let audioContext;
    const audioEl = document.getElementById('audioEl');


    function playVoice(audio) {
      const audioUrl = URL.createObjectURL(audio);
      audioEl.src = audioUrl;
      audioEl.play();
    }

    async function start() {
      stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      audioContext = new AudioContext();

      const analyser = audioContext.createAnalyser();
      mediaRecorder = new MediaRecorder(stream);
      streamSource = audioContext.createMediaStreamSource(stream);


      let isNeedPlay = false;
      let isPlaying = false;
      mediaRecorder.ondataavailable = (ex) => {
        if (isNeedPlay && !isPlaying) {
          isPlaying = true;
          playVoice(ex.data);
          const last = new Uint8Array(ex.data);
          setTimeout(() => {
            isNeedPlay = false;
            isPlaying = false;
          }, timeSpace);
        }
      }

      streamSource.connect(analyser);
      let last = new Uint8Array(analyser.frequencyBinCount);

      startRecord(mediaRecorder);

      document.getElementById("status").innerText = "运行中。。。";
      document.getElementById("start").setAttribute('disabled', '');

      let time = Date.now();
      timer = setInterval(() => {
        time = Date.now();
        if (!isPlaying) {
          if (mediaRecorder.state == 'recording') {
            mediaRecorder.requestData();
            analyser.getByteFrequencyData(last);
          }

          if (isLouder()) {
            isNeedPlay = true;
            stopRecord(mediaRecorder);
            last = new Uint8Array(analyser.frequencyBinCount);
          } else {
            startRecord(mediaRecorder);
          }
        }
      }, timeSpace)

      function isLouder() {
        let loudTimes = 0;
        for (let i = 0; i < last.length; i++) {
          if (last[i] > 10) {
            if (++loudTimes > 3) {
              return true;
            }
          } else {
            loudTimes = 0;
          }
        }

        return false;
      }
    }

    function startRecord(mediaRecorder) {
      if (mediaRecorder.state != 'recording') {
        mediaRecorder.start();
      }
    }

    function stopRecord(mediaRecorder) {
      if (mediaRecorder.state != 'inactive') {
        mediaRecorder.stop();
      }
    }

    function stop() {
      clearInterval(timer);
      streamSource.disconnect();
      document.getElementById("status").innerText = "已停止";
      document.getElementById("start").removeAttribute('disabled');
    }
  </script>
</body>

</html>